name: 'My Composite Action'
description: 'Combines multiple steps'
runs:
  using: "composite"
  steps:
    - name: è§¦å‘å¯åŠ¨å¼€å§‹ç¼–è¯‘
      id: gitpush
      shell: bash
      run: |
        cd ${GITHUB_WORKSPACE}
        tmpdir="$(mktemp -d)" && UPLOAD="$GITHUB_WORKSPACE/${tmpdir#*.}"
        git clone -b ${GIT_REFNAME} https://user:${REPO_TOKEN}@github.com/${GIT_REPOSITORY}.git $UPLOAD
        [[ -d "$UPLOAD/build" ]] && rm -rf $UPLOAD/build
        cp -Rf ${HOME_PATH}/build_logo/config.txt $MYCONFIG_FILE
        cp -Rf $OPERATES_PATH $UPLOAD/build
        [[ -d "$UPLOAD/build/common" ]] && rm -rf $UPLOAD/build/common
        cp -Rf $GITHUB_WORKSPACE/.github/workflows/* $UPLOAD/.github/workflows
        mkdir -p "$UPLOAD/build/${FOLDER_NAME}/relevance"
        echo "${SOURCE}-${REPO_BRANCH}-${CONFIG_FILE}-$(date +%Yå¹´%mæœˆ%då·%Hæ—¶%Måˆ†%Sç§’)" > $UPLOAD/build/${FOLDER_NAME}/relevance/start
        cp -Rf $COMPILE_PATH/relevance/settings.ini $UPLOAD/build/${FOLDER_NAME}/relevance/settings.ini
        YML_PATH="$UPLOAD/.github/workflows/compile.yml"
        TARGET1="$(grep 'target: \[' "${YML_PATH}" |sed 's/^[ ]*//g' |grep -v '^#' |sed 's/\[/\\&/' |sed 's/\]/\\&/')"
        TARGET2="target: \\[${FOLDER_NAME}\\]"
        PATHS1="$(grep -Eo "\- '.*'" "${YML_PATH}" |sed 's/^[ ]*//g' |grep -v "^#" |awk 'NR==1')"
        PATHS2="- 'build/${FOLDER_NAME}/relevance/start'"
        if [[ -n "${PATHS1}" ]] && [[ -n "${TARGET1}" ]]; then
          sed -i "s?${PATHS1}?${PATHS2}?g" "${YML_PATH}"
          sed -i "s?${TARGET1}?${TARGET2}?g" "${YML_PATH}"
        else
          echo "è·å–å˜é‡å¤±è´¥,è¯·å‹¿èƒ¡ä¹±ä¿®æ”¹compile.ymlæ–‡ä»¶"
          exit 1
        fi
        chmod -R +x $UPLOAD
        cd $UPLOAD
        git add .
        git commit -m "ç¼–è¯‘-${FOLDER_NAME}-${LUCI_EDITION}-${TARGET_PROFILE}å›ºä»¶"
        git push --force "https://${REPO_TOKEN}@github.com/${GIT_REPOSITORY}" HEAD:${GIT_REFNAME}
        if [[ $? -ne 0 ]]; then
          echo -e "\033[31m è§¦å‘ç¼–è¯‘${FOLDER_NAME}-${LUCI_EDITION}-${TARGET_PROFILE}å¤±è´¥ \033[0m"
        else
          echo -e "\033[33m è§¦å‘ç¼–è¯‘${FOLDER_NAME}-${LUCI_EDITION}-${TARGET_PROFILE}æˆåŠŸ \033[0m"
        fi

    - name: ä¿¡æ¯é€šçŸ¥çš„æ—¶é—´
      shell: bash
      run: |
        cd ${GITHUB_WORKSPACE}
        echo "TZ_Message=$(date +%Yå¹´%mæœˆ%då·%Hæ—¶%Måˆ†)" >> ${GITHUB_ENV}
        
    - name: Telegramæˆ–pushplusä¿¡æ¯é€šçŸ¥
      if: env.PUSH_PLUS_TOKEN && env.INFORMATION_NOTICE == 'PUSH' && steps.gitpush.outcome == 'success' || env.TELEGRAM_BOT_TOKEN && env.INFORMATION_NOTICE == 'TG' && steps.gitpush.outcome == 'success'
      shell: bash
      run: |
        cd ${GITHUB_WORKSPACE}
        if [[ "${{ env.INFORMATION_NOTICE }}" == "TG" ]]; then
          curl -s -X POST -H "Content-Type: application/json" -d '{"chat_id":"${{env.TELEGRAM_CHAT_ID}}", "text":"è§¦å‘å¯åŠ¨${{env.SOURCE}}-${{env.LUCI_EDITION}}ï¼Œç¼–è¯‘${{env.TARGET_PROFILE}}å›ºä»¶ï¼Œè¯·è€å¿ƒç­‰å¾…...... ğŸ˜‹ï¼Œ(${{env.WAREHOUSE_MAN}}-#${{env.RUN_NUMBER}})ï¼Œ${{env.TZ_Message}}ğŸ’"}' https://api.telegram.org/bot${{env.TELEGRAM_BOT_TOKEN}}/sendMessage
        fi
        if [[ "${{ env.INFORMATION_NOTICE }}" == "PUSH" ]]; then
          curl -s -X POST -H "Content-Type: application/json" -d '{"token":"${{env.PUSH_PLUS_TOKEN}}","title":"è§¦å‘å¯åŠ¨${{env.SOURCE}}-${{env.LUCI_EDITION}}","content":"ç¼–è¯‘${{env.TARGET_PROFILE}}å›ºä»¶ï¼Œè¯·è€å¿ƒç­‰å¾…...... ğŸ˜‹ï¼Œ(${{env.WAREHOUSE_MAN}}-#${{env.RUN_NUMBER}})ï¼Œ${{env.TZ_Message}}ğŸ’"}' https://www.pushplus.plus/send
        fi
branding:
  icon: "terminal"
  color: "gray-dark"
