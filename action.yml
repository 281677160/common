name: 'è§¦å‘ç¼–è¯‘å·¥ä½œæµ'
description: 'é€šè¿‡æ¨é€ä»£ç åˆ°æŒ‡å®šä»“åº“åˆ†æ”¯è§¦å‘ç¼–è¯‘æµç¨‹'
inputs:
  git-refname:
    description: 'Git åˆ†æ”¯åç§°'
    required: true
  repo-token:
    description: 'è®¿é—®ä»“åº“çš„ token'
    required: true
    default: ${{ github.token }}
  git-repository:
    description: 'Git ä»“åº“åç§°'
    required: true
  folder-name:
    description: 'å›ºä»¶æ–‡ä»¶å¤¹åç§°'
    required: true
  config-txt:
    description: 'é…ç½®æ–‡ä»¶è·¯å¾„'
    required: true
  myconfig-file:
    description: 'ç›®æ ‡é…ç½®æ–‡ä»¶è·¯å¾„'
    required: true
  compile-path:
    description: 'ç¼–è¯‘æ–‡ä»¶è·¯å¾„'
    required: true
  source:
    description: 'æºç æ ‡è¯†'
    required: true
  repo-branch:
    description: 'ä»“åº“åˆ†æ”¯'
    required: true
  config-file:
    description: 'é…ç½®æ–‡ä»¶æ ‡è¯†'
    required: true
  run-number:
    description: 'è¿è¡Œç¼–å·'
    required: true
  luci-edition:
    description: 'LuCI ç‰ˆæœ¬'
    required: true
  target-profile:
    description: 'ç›®æ ‡è®¾å¤‡é…ç½®'
    required: true
runs:
  using: "composite"
  steps:
    - name: è§¦å‘å¯åŠ¨å¼€å§‹ç¼–è¯‘
      id: gitpush
      shell: bash
      run: |
        set -euo pipefail
        
        # å®šä¹‰é¢œè‰²è¾“å‡ºå‡½æ•°
        log_info() { echo -e "\033[32mINFO: $1\033[0m"; }
        log_warn() { echo -e "\033[33mWARN: $1\033[0m"; }
        log_error() { echo -e "\033[31mERROR: $1\033[0m"; }
        
        log_info "å¼€å§‹è§¦å‘ç¼–è¯‘æµç¨‹..."
        
        cd "${{ github.workspace }}"
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        log_info "åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•..."
        tmpdir="$(mktemp -d)"
        UPLOAD="${{ github.workspace }}/${tmpdir#*.}"
        
        # å…‹éš†ä»“åº“
        log_info "å…‹éš†ä»“åº“ ${{ inputs.git-repository }} åˆ†æ”¯ ${{ inputs.git-refname }}..."
        git clone -b "${{ inputs.git-refname }}" "https://user:${{ inputs.repo-token }}@github.com/${{ inputs.git-repository }}.git" "$UPLOAD"
        cd "$UPLOAD"
        git reset --hard HEAD
        cd "${{ github.workspace }}"
        
        # æ¸…ç†å’Œå¤åˆ¶æ–‡ä»¶
        log_info "å‡†å¤‡ç¼–è¯‘æ–‡ä»¶..."
        if [[ -d "$UPLOAD/build/${{ inputs.folder-name }}" ]]; then
          log_info "æ¸…ç†æ—§çš„ç¼–è¯‘ç›®å½•..."
          rm -rf "$UPLOAD/build/${{ inputs.folder-name }}"
        fi
        
        log_info "å¤åˆ¶é…ç½®æ–‡ä»¶..."
        cp -Rf "${{ inputs.config-txt }}" "${{ inputs.myconfig-file }}"
        
        log_info "å¤åˆ¶ç¼–è¯‘æ–‡ä»¶..."
        cp -Rf "${{ inputs.compile-path }}" "$UPLOAD/build/${{ inputs.folder-name }}"
        
        if [[ -d "$UPLOAD/build/common" ]]; then
          log_info "æ¸…ç†å…¬å…±æ–‡ä»¶ç›®å½•..."
          rm -rf "$UPLOAD/build/common"
        fi
        
        log_info "æ›´æ–°ç¼–è¯‘å·¥ä½œæµé…ç½®..."
        cp -Rf "${{ github.workspace }}/.github/workflows/compile.yml" "$UPLOAD/.github/workflows/compile.yml"
        
        # åˆ›å»ºç›¸å…³ç›®å½•å’Œæ–‡ä»¶
        log_info "åˆ›å»ºç¼–è¯‘ç›¸å…³æ–‡ä»¶..."
        mkdir -p "$UPLOAD/build/${{ inputs.folder-name }}/relevance"
        echo "${{ inputs.source }}-${{ inputs.repo-branch }}-${{ inputs.config-file }}-$(date +%Yå¹´%mæœˆ%då·%Hæ—¶%Måˆ†%Sç§’)" > "$UPLOAD/build/${{ inputs.folder-name }}/relevance/start"
        cp -Rf "${{ inputs.compile-path }}/relevance/settings.ini" "$UPLOAD/build/${{ inputs.folder-name }}/relevance/settings.ini"
        echo "ERRUN_NUMBER=${{ inputs.run-number }}" >> "$UPLOAD/build/${{ inputs.folder-name }}/relevance/settings.ini"
        
        # ä¿®æ”¹ç¼–è¯‘é…ç½®æ–‡ä»¶
        log_info "æ›´æ–°ç¼–è¯‘é…ç½®æ–‡ä»¶..."
        YML_PATH="$UPLOAD/.github/workflows/compile.yml"
        PATHS="build/${{ inputs.folder-name }}/relevance/start"
        
        # ä½¿ç”¨æ›´å¥å£®çš„sedå‘½ä»¤
        sed -i "/branches:/,/paths:/s|- .*|- ${{ inputs.git-refname }}|" "$YML_PATH"
        sed -i "/paths:/,/matrix:/s@- .*@- '${PATHS//@/\\@}'@" "$YML_PATH"
        sed -i "/matrix:/,/^ *target:/s/target:.*/  target: [${{ inputs.folder-name }}]/" "$YML_PATH"
        
        # æäº¤å¹¶æ¨é€
        log_info "æäº¤å¹¶æ¨é€æ›´æ”¹..."
        chmod -R +x "$UPLOAD"
        cd "$UPLOAD"
        
        git status
        
        log_info "æ·»åŠ æ›´æ”¹åˆ°æš‚å­˜åŒº..."
        git add .
        
        log_info "æäº¤æ›´æ”¹..."
        git commit -m "ç¼–è¯‘-${{ inputs.folder-name }}-${{ inputs.luci-edition }}-${{ inputs.target-profile }}å›ºä»¶"
        
        log_info "æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“..."
        PUSH_SUCCESS=false
        
        for i in {1..3}; do
          echo "å°è¯•æ¨é€ (${i}/3)..."
          if git push --force "https://${{ inputs.repo-token }}@github.com/${{ inputs.git-repository }}" HEAD:${{ inputs.git-refname }}; then
            PUSH_SUCCESS=true
            break
          else
            log_warn "æ¨é€å¤±è´¥ï¼Œç­‰å¾…2ç§’åé‡è¯•..."
            sleep 2
          fi
        done
        
        # æ£€æŸ¥æ¨é€ç»“æœ
        if [ "$PUSH_SUCCESS" = false ]; then
          log_error "è§¦å‘ç¼–è¯‘å¤±è´¥,è¯·å‹¿èƒ¡ä¹±ä¿®æ”¹compile.ymlæ–‡ä»¶"
          exit 1
        else
          log_info "è§¦å‘ç¼–è¯‘${{ inputs.folder-name }}-${{ inputs.luci-edition }}-${{ inputs.target-profile }}æˆåŠŸ"
          echo "compile-triggered=true" >> $GITHUB_ENV
        fi

    - name: ä¿¡æ¯é€šçŸ¥çš„æ—¶é—´
      if: steps.gitpush.outcome == 'success'
      shell: bash
      run: |
        cd ${GITHUB_WORKSPACE}
        echo "TZ_Message=$(date +%Yå¹´%mæœˆ%då·%Hæ—¶%Måˆ†)" >> "${GITHUB_ENV}"

    - name: Telegramæˆ–pushplusä¿¡æ¯é€šçŸ¥
      if: env.PUSH_PLUS_TOKEN && env.INFORMATION_NOTICE == 'PUSH' && steps.gitpush.outcome == 'success' || env.TELEGRAM_BOT_TOKEN && env.INFORMATION_NOTICE == 'TG' && steps.gitpush.outcome == 'success'
      shell: bash
      run: |
        if [[ "${{ env.INFORMATION_NOTICE }}" == "TG" ]]; then
          curl -s -X POST -H "Content-Type: application/json" -d '{"chat_id":"${{env.TELEGRAM_CHAT_ID}}", "text":"è§¦å‘å¯åŠ¨${{env.SOURCE}}-${{env.LUCI_EDITION}}ï¼Œç¼–è¯‘${{env.TARGET_PROFILE}}å›ºä»¶ï¼Œè¯·è€å¿ƒç­‰å¾…...... ğŸ˜‹ï¼Œ(${{env.WAREHOUSE_MAN}}-#${{env.RUN_NUMBER}})ï¼Œ${{env.TZ_Message}}ğŸ’"}' "https://api.telegram.org/bot${{env.TELEGRAM_BOT_TOKEN}}/sendMessage"
        fi
        if [[ "${{ env.INFORMATION_NOTICE }}" == "PUSH" ]]; then
          curl -s -X POST -H "Content-Type: application/json" -d '{"token":"${{env.PUSH_PLUS_TOKEN}}","title":"è§¦å‘å¯åŠ¨${{env.SOURCE}}-${{env.LUCI_EDITION}}","content":"ç¼–è¯‘${{env.TARGET_PROFILE}}å›ºä»¶ï¼Œè¯·è€å¿ƒç­‰å¾…...... ğŸ˜‹ï¼Œ(${{env.WAREHOUSE_MAN}}-#${{env.RUN_NUMBER}})ï¼Œ${{env.TZ_Message}}ğŸ’"}' "https://www.pushplus.plus/send"
        fi
branding:
  icon: "terminal"
  color: "gray-dark"
