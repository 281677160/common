name: 'My Composite Action'
description: 'Combines multiple steps'
runs:
  using: "composite"
  steps:
    - name: è§¦å‘å¯åŠ¨å¼€å§‹ç¼–è¯‘
      id: gitpush
      shell: bash
      run: |
        cd ${GITHUB_WORKSPACE}
        tmpdir="$(mktemp -d)"
        UPLOAD="$GITHUB_WORKSPACE/${tmpdir#*.}"

        # å…‹éš†ä»“åº“
        git clone --depth=1 -b ${GIT_REFNAME} https://user:${REPO_TOKEN}@github.com/${GIT_REPOSITORY}.git $UPLOAD
        cd $UPLOAD
        git reset --hard HEAD
        cd ${GITHUB_WORKSPACE}

        # æ¸…ç†å’Œå¤åˆ¶æ–‡ä»¶
        [[ -d "$UPLOAD/build/${FOLDER_NAME}" ]] && rm -rf "$UPLOAD/build/${FOLDER_NAME}"
        cp -Rf "$CONFIG_TXT" "$MYCONFIG_FILE"
        cp -Rf "$COMPILE_PATH" "$UPLOAD/build/$FOLDER_NAME"
        [[ -d "$UPLOAD/build/common" ]] && rm -rf "$UPLOAD/build/common"
        cp -Rf "$GITHUB_WORKSPACE/.github/workflows/compile.yml" "$UPLOAD/.github/workflows/compile.yml"

        # åˆ›å»ºç›¸å…³ç›®å½•å’Œæ–‡ä»¶
        mkdir -p "$UPLOAD/build/${FOLDER_NAME}/relevance"
        echo "${SOURCE}-${REPO_BRANCH}-${CONFIG_FILE}-$(date +%Yå¹´%mæœˆ%då·%Hæ—¶%Måˆ†%Sç§’)" > "$UPLOAD/build/${FOLDER_NAME}/relevance/start"
        cp -Rf "$COMPILE_PATH/relevance/settings.ini" "$UPLOAD/build/${FOLDER_NAME}/relevance/settings.ini"
        echo "ERRUN_NUMBER=${RUN_NUMBER}" >> "$UPLOAD/build/${FOLDER_NAME}/relevance/settings.ini"

        # ä¿®æ”¹ç¼–è¯‘é…ç½®æ–‡ä»¶
        YML_PATH="$UPLOAD/.github/workflows/compile.yml"
        PATHS="build/${FOLDER_NAME}/relevance/start"
        sed -i "/branches:/,/paths:/s|- .*|- ${GIT_REFNAME}|" "$YML_PATH"
        sed -i "/paths:/,/matrix:/s@- .*@- '${PATHS//@/\\@}'@" "$YML_PATH"
        sed -i "/matrix:/,/^ *target:/s/target:.*/target: [${FOLDER_NAME}]/" "$YML_PATH"

        # æäº¤å¹¶æ¨é€
        BANBEN_SHUOMING="ç¼–è¯‘-${FOLDER_NAME}-${LUCI_EDITION}-${TARGET_PROFILE}å›ºä»¶"
        chmod -R +x "$UPLOAD"
        cd "$UPLOAD"
        find "$UPLOAD" -type f -size +100M -exec rm -f {} \; || true
        git status
        git add .
        git commit -m "${BANBEN_SHUOMING}"
        PUSH_SUCCESS=false
        RETRY_COUNT=0
        MAX_RETRIES=5
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          RETRY_COUNT=$((RETRY_COUNT+1))
          echo "å°è¯•æ¨é€ (${RETRY_COUNT}/${MAX_RETRIES})..."
          # æ¯æ¬¡é‡è¯•å‰é‡ç½®HEADå¹¶é‡æ–°æ·»åŠ æ–‡ä»¶
          if [ $RETRY_COUNT -gt 1 ]; then
             echo "é‡ç½®HEADå¹¶é‡æ–°æ·»åŠ æ–‡ä»¶..."
             git reset --hard HEAD
             git add .
          fi
          if git push --force "https://${REPO_TOKEN}@github.com/${GIT_REPOSITORY}" HEAD:${GIT_REFNAME}; then
             PUSH_SUCCESS=true
             break
          else
             echo "æ¨é€å¤±è´¥ï¼Œå°è¯•æ¢å¤..."
             # æ¸…é™¤å¯èƒ½æŸåçš„ç¼“å­˜
             git gc --prune=now
             git remote prune origin
             # å¢åŠ éšæœºå»¶è¿Ÿï¼Œé¿å…æŒç»­å³°å€¼è¯·æ±‚
             DELAY=$((RANDOM % 5 + 2))
             echo "ç­‰å¾…${DELAY}ç§’åé‡è¯•..."
             sleep $DELAY
          fi
        done

        # æ£€æŸ¥æ¨é€ç»“æœ
        if [ "$PUSH_SUCCESS" = false ]; then
           echo -e "\033[31m è§¦å‘ç¼–è¯‘å¤±è´¥,è¯·å‹¿èƒ¡ä¹±ä¿®æ”¹compile.ymlæ–‡ä»¶ \033[0m"
           exit 1
        else
           echo -e "\033[32m è§¦å‘ç¼–è¯‘${FOLDER_NAME}-${LUCI_EDITION}-${TARGET_PROFILE}æˆåŠŸ \033[0m"
        fi

    - name: ä¿¡æ¯é€šçŸ¥çš„æ—¶é—´
      if: steps.gitpush.outcome == 'success'
      shell: bash
      run: |
        cd ${GITHUB_WORKSPACE}
        echo "TZ_Message=$(date +%Yå¹´%mæœˆ%då·%Hæ—¶%Måˆ†)" >> "${GITHUB_ENV}"

    - name: Telegramæˆ–pushplusä¿¡æ¯é€šçŸ¥
      if: env.PUSH_PLUS_TOKEN && env.INFORMATION_NOTICE == 'PUSH' && steps.gitpush.outcome == 'success' || env.TELEGRAM_BOT_TOKEN && env.INFORMATION_NOTICE == 'TG' && steps.gitpush.outcome == 'success'
      shell: bash
      run: |
        if [[ "${{ env.INFORMATION_NOTICE }}" == "TG" ]]; then
           curl -s -X POST -H "Content-Type: application/json" -d '{"chat_id":"${{env.TELEGRAM_CHAT_ID}}", "text":"è§¦å‘å¯åŠ¨${{env.SOURCE}}-${{env.LUCI_EDITION}}ï¼Œç¼–è¯‘${{env.TARGET_PROFILE}}å›ºä»¶ï¼Œè¯·è€å¿ƒç­‰å¾…...... ğŸ˜‹ï¼Œ(${{env.WAREHOUSE_MAN}}-#${{env.RUN_NUMBER}})ï¼Œ${{env.TZ_Message}}ğŸ’"}' "https://api.telegram.org/bot${{env.TELEGRAM_BOT_TOKEN}}/sendMessage"
        fi
        if [[ "${{ env.INFORMATION_NOTICE }}" == "PUSH" ]]; then
           curl -s -X POST -H "Content-Type: application/json" -d '{"token":"${{env.PUSH_PLUS_TOKEN}}","title":"è§¦å‘å¯åŠ¨${{env.SOURCE}}-${{env.LUCI_EDITION}}","content":"ç¼–è¯‘${{env.TARGET_PROFILE}}å›ºä»¶ï¼Œè¯·è€å¿ƒç­‰å¾…...... ğŸ˜‹ï¼Œ(${{env.WAREHOUSE_MAN}}-#${{env.RUN_NUMBER}})ï¼Œ${{env.TZ_Message}}ğŸ’"}' "https://www.pushplus.plus/send"
        fi
branding:
  icon: "terminal"
  color: "gray-dark"
